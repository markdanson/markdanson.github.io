<!DOCTYPE html>
<html lang="en">
    <head>   
     <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
     <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
     <link rel="stylesheet" href="css/style.css">

        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <meta charset="UTF-8">
        <title>ðŸ§­ GuideMap Demo</title>


    </head>
<body>
    
    <div class="ui" id="settings">
        <span id="settings-toggle" class="material-icons">settings</span>
        <div id="settings-options">
            <div class="option" id="map-toggle">
                <div id="toggle">
                    <span class="on material-icons">toggle_on</span>
                    <span class="off material-icons">toggle_off</span>
                </div>
                <span id="text">Satellite view</span>
            </div>
            <div class="option" id="settings-clear">
                <span class="material-icons">delete_forever</span>
                <span id="settings-clear-text">Clear Data</span>

                </div>
                <button id="goFS">Go fullscreen</button>
                <script>
                var goFS = document.getElementById("goFS");
                goFS.addEventListener("click", function() {
                    document.body.requestFullscreen();
                }, false);
                </script>
        </div>
       
    </div>




    <div class="ui" id="camera-toggle">
        <span class="on material-icons">qr_code_2</span>
        <span class="off material-icons">close</span></div>
    <div class="ui" id="geolocation-toggle">
        <span class="off material-icons">gps_not_fixed</span>
        <span class="unavailable material-icons">gps_off</span>
        <span class="on material-icons">gps_fixed</span>
    </div>




    <div id="qr-cam" >
        <div id="qr-cam-holder">
            <span id="cam-has-camera"></span>
            <video id="qr-video"></video>
            <br>
        </div>

        <span id="cam-qr-result">Scanning</span>
        
        <div id="qr-select-holder">
            <input type="file" id="file-selector">
            <span id="file-qr-result"></span>
        </div>
    </div>
    
    <div id="welcome"></div>
    <div id="map"></div>
    
    <script>
        
        let map, infoWindow, firstTime;
      
        var items=[];  var hintAreas=[];  var hintPopups=[];   var revealMarkers=[]; var revealPopups=[]; 
        const MAP_MARKER = 'M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z';



        items.push(pink = {
            position: { lat: 52.194407, lng: 0.1256567 },
            name: 'pink',
            revealText: "<h1>Reveal 1</h1><p>info about this marker</p>",
            hintText: "<h1>Hint 1</h1><p>info about this marker</p>"
            });
        items.push( blue = {
            position: { lat: 52.193142, lng: 0.1244538 },
            name: 'blue',
            revealText: "<h1>Reveal 2</h1><p>info about this marker</p>",
            hintText: "<h1>Hint 2</h1><p>info about this marker</p>"
            });
        items.push( coral = {
            position: { lat: 52.194407, lng: 0.1296557 },
            name: 'coral',
            revealText: "<h1>Reveal 3</h1><p>info about this marker</p>",
            hintText: "<h1>Hint 3</h1><p>info about this marker</p>"
            });
        items.push(green = {
            position: { lat: 52.193142, lng: 0.1281528 },
            name: 'green',  
            revealText: "<h1>Reveal 4</h1><p>info about this marker</p>",
            hintText: "<h1>Hint 4</h1><p>info about this marker</p>"
            });

        items.forEach(item => {
            item.revealMarker = item.name+"Marker";
            item.revealPopup = item.name+"Popup";
            item.hintArea = item.name+"HintArea";
            item.hintPopup = item.name+"HintPopup";
        });
        const home = { lat: 52.193616, lng: 0.126948 };

        var hash = window.location.hash.split('#')[1];
       
        if(items.find(x => x.name === hash)) {
           // localStorage.firstTime = true;
            document.getElementById("welcome").innerHTML = "<h1><span class='material-icons'>visibility</span><span class='material-icons'>qr_code</span><span class='material-icons'>my_location</span> You found a secret!</h1><p>Welcome to the Guidemap!</p><p>Use this map to guide you to an area of interest, then when you find the QR code, open the camera below to scan the code and find out more!</p>";
        }else if(localStorage.revealedItems){ 
         //   localStorage.notFirstTime = true;
            document.getElementById("welcome").innerHTML = "<h1><span class='material-icons'>visibility</span><span class='material-icons'>qr_code</span><span class='material-icons'>my_location</span> Welcome back!</h1><p>Welcome to the Guidemap!</p><p>Use this map to guide you to an area of interest, then when you find the QR code, open the camera below to scan the code and find out more!</p><p>P.S. Your progress from last time has been saved, click the <span style='font-size:1em' class='material-icons'>settings</span> settings icon to clear your data.";
         }else {
           // firstTime = true;
            document.getElementById("welcome").innerHTML =  "<h1><span class='material-icons'>visibility</span><span class='material-icons'>qr_code</span><span class='material-icons'>my_location</span> Welcome!</h1><p>Welcome to the Guidemap!</p><p>Use this map to guide you to an area of interest, then when you find the QR code, open the camera below to scan the code and find out more!</p>";
         };
         
         // Settings: satellite, GPS, reveals, clear data
         
        function initMap() {
            
            const map = new google.maps.Map(document.getElementById("map"), {
                zoom: 17,
                center: home,
                mapTypeId: localStorage.mapType,
                mapId: '79077c97c96d524b',
                disableDefaultUI: true,  
               // streetViewControl: true,
                tilt:0,
             /*   styles:[{
                    "featureType": "all",
                    "elementType": "labels",
                    "stylers": [
                        { "visibility": "off" }
                    ]
                }]*/
            });

        // intro popup + marker

            const welcomeMarker = new google.maps.Marker({
                position: home,
                map,
                icon: {
                    path: MAP_MARKER,
                    scale: 1.8, // > 1 to make it bigger
                    fillColor: 'rgba(186,104,200,1)', // Use RGBa function
                    fillOpacity: 1,
                    strokeColor: 'hsla(291,47%,51%,1)', // Use HSLa function
                    anchor: { x: 12, y: 24 },
                },
               
            });
            if(!localStorage.notFirstTime) {
                welcomeMarker.setAnimation(google.maps.Animation.BOUNCE);
            }
            
            welcomeMarker.addListener("click", () => {
            //   map.setZoom(20);         
                welcomeMarker.setAnimation(null);
                closePopups();
                map.panTo(welcomeMarker.position);
                localStorage.notFirstTime = true;                
                window.location.hash = "hello";
                hashChange();
              // document.getElementById("welcome").classList.add("open");       
            });
            

            map.addListener("center_changed", () => {
            //    document.getElementById("welcome").classList.remove("open");        
            });
            
            map.addListener("click", () => {
               window.location.hash = ""; 
               document.getElementById("welcome").classList.remove("open");
               
               closePopups(); 
            });

            
            for(i=0;i<items.length;i++) {  
                createHint(items[i]);
            }

            
            function createHint(item) {

                item.hintArea =  new google.maps.Circle({
                    strokeColor: "#FF0000",
                    strokeOpacity: 0.8,
                    strokeWeight: 2,
                    fillColor: "#FF0000",
                    fillOpacity: 0.35,
                    map,
                    center: item.position,
                    radius: 10,
                    title:item.name,
                });
                hintAreas.push(item.hintArea);

                item.hintPopup = new google.maps.InfoWindow({
                    position:item.position,
                    content:item.hintText,
                    maxWidth: 200,
                });
                hintPopups.push(item.hintPopup);

                
                item.hintArea.addListener("click", () => {
                    closePopups();
                    window.location.hash = "";
                    map.panTo(item.position);
                    item.hintPopup.open(map);
                });
            }   
           
            function closePopups () {
                document.getElementById("welcome").classList.remove("open");
                revealPopups.forEach(revealPopup => revealPopup.close()); // close all reveal popups
                hintPopups.forEach(hintPopup => hintPopup.close()); // close all reveal popups
               /*** dont put window.location.hash = "" in here  ***/
            }

           
            
            function show (hash) {

                revealPopups.forEach(revealPopup => revealPopup.close()); // close all reveal popups
                hintPopups.forEach(hintPopup => hintPopup.close()); // close all reveal popups
            
               
                const item = items.find(x => x.name === hash);
                const index = items.indexOf(item);
                hintAreas[index].setMap(null); //hide hint for this scan
              
                if(!revealMarkers.find(x => x.title === item.name)) { //not there, create marker & popup

                    item.revealMarker = new google.maps.Marker({
                        position: item.position,
                        map,
                        animation: google.maps.Animation.DROP,
                        title: item.name,
                        icon: {
                            path: MAP_MARKER,
                            scale: 1.8, // > 1 to make it bigger
                            fillColor: 'rgba(234,71,71,1)', // Use RGBa function
                            fillOpacity: 1,
                            strokeColor: 'hsla(0,71%,46%,1)', // Use HSLa function
                            anchor: { x: 12, y: 24 },
                        },
                    
                    });
                    revealMarkers.push(item.revealMarker);
                    item.markerObj = item.revealMarker;

                    item.revealMarker.addListener("click", () => {
                        closePopups();
                        map.panTo(item.position);
                        item.revealPopup.open(map);
                        window.location.hash = hash;
                        
                    });

                    item.revealPopup = new google.maps.InfoWindow({
                        position:item.position,
                        content:item.revealText,
                        maxWidth: 200,
                        pixelOffset:{height:-40, width: 0}
                    });
                    revealPopups.push(item.revealPopup);
                    item.popupObj = item.revealPopup;

                    if(!revealedItems.includes(hash)) {
                        revealedItems.push(hash);
                        localStorage.setItem("revealedItems", JSON.stringify(revealedItems));
                    }
                }
                return {
                    marker: item.markerObj,
                    popup: item.popupObj,
                };
               
            }

            function hashChange() {
                hash = window.location.hash.split('#')[1];
                closePopups();
                if(items.find(x => x.name === hash)) {
                    var hashReveal = show(hash);
                    map.panTo(hashReveal.marker.position);
                    hashReveal.popup.open(map);
                } 
                if(hash == "hello"){
                    document.getElementById("welcome").classList.add("open");

                } 

            }


///////////////////////////////////////////////////
//                                               //
//          S E T T I N G S                      //
//                                               //
///////////////////////////////////////////////////
            

            var settings_options = document.getElementById('settings-options');
            var settings_toggle = document.getElementById('settings-toggle');

            settings_toggle.addEventListener('click', () => {

                if(settings_options.classList.contains("open")) {
                    settings_options.classList.remove("open");
                } else {
                    settings_options.classList.add("open");
                }
            });
        

            var geo_toggle = document.getElementById('geolocation-toggle');
            geo_toggle.addEventListener('click', () => {
                settings_options.classList.remove("open");
                console.log('Retrieving GPS');
                geo_toggle.classList.add("searching");

               // geo_toggle.classList
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        // success
                        
                        function(position) {
                            console.log("GPS success: lat " + position.coords.latitude + ", long " + position.coords.longitude)
                            const pos = {
                                    lat: position.coords.latitude,
                                    lng: position.coords.longitude,
                                };
                            geo_toggle.classList.add("on");
                            geo_toggle.classList.remove("searching");

                            geoMarker = new google.maps.Marker({
                                position: pos,
                                map,
                                animation: google.maps.Animation.DROP,
                                title: item.name,
                                icon: {
                                    path: MAP_MARKER,
                                    scale: 1.8, // > 1 to make it bigger
                                    fillColor: 'rgba(234,71,71,1)', // Use RGBa function
                                    fillOpacity: 1,
                                    strokeColor: 'hsla(0,71%,46%,1)', // Use HSLa function
                                    anchor: { x: 12, y: 24 },
                                },
                    
                            });
                            map.setCenter(pos);
                         /*   infoWindow.setPosition(pos);
                            infoWindow.setContent("Location found.");
                            infoWindow.open(map);
                            map.setCenter(pos); */

                        }, 
                        // failure
                        function(error) {
                            console.log("GPS Fail: " + error.message)
                            geo_toggle.classList.add("unavailable");
                            geo_toggle.classList.remove("searching");
                        },
                        {
                        timeout: 5000 // ms
                        }
                    )
                    } else {
                        console.log("GPS Fail: not supported by browser")
                        geo_toggle.classList.add("unavailable");
                        geo_toggle.classList.remove("searching");
                    }
                
            });

            var map_toggle = document.getElementById('map-toggle');
            map_toggle.addEventListener('click', () => {
                if(map_toggle.classList.contains("satellite")) {
                    map_toggle.classList.remove("satellite");
                    map_toggle.classList.add("roadmap");
                    map.setMapTypeId('roadmap');
                    localStorage.mapType = "roadmap";
                } else {
                    map_toggle.classList.add("satellite");
                    map_toggle.classList.remove("roadmap");
                    map.setMapTypeId('satellite');
                    localStorage.mapType = "satellite";
                }
                
            });


            var settings_clear = document.getElementById('settings-clear');
            var settings_clear_text = document.getElementById('settings-clear-text');
            
            settings_clear.addEventListener('click', () => {
                hash = "";
                window.location.hash = hash;
                localStorage.clear();
                setTimeout(function(){ 
                    settings_clear_text.classList.add('done');
                    settings_clear_text.innerHTML = "Cleared";
                }, 500);
                setTimeout(function(){ 
                    settings_clear_text.classList.remove('done');
                    settings_clear_text.innerHTML = "Reloading...";
                }, 1500);
                setTimeout(function(){ 
                    location.reload();
                }, 2500);
                
            });


        ///////////////////////////////////////////////////
        //                                               //
        //          L O C A L   S T O R A G E            //
        //                                               //
        ///////////////////////////////////////////////////

            if (!localStorage.visited) {
                localStorage.visited = true;
            }

            //  get map settings
            if (localStorage.mapType) {
                    localStorage.mapType = localStorage.mapType;
                    document.getElementById('map-toggle').classList.add(localStorage.mapType);
                } else {
                    localStorage.mapType = 'roadmap'; //set first use to roadmap
                    document.getElementById('map-toggle').classList.add("roadmap");
                }

            // get previous reveals

            if(localStorage.revealedItems) {
                var revealedItems = JSON.parse(localStorage.getItem("revealedItems"));
                revealedItems.forEach(item => { show(item) });
            }else{
                var revealedItems=[];  
            }
                
            // get gps status
    

            google.maps.event.addDomListener(window, "hashchange", () => {
               hashChange();
            });

            //if page is loaded with a hash (i.e. loaded straight from QR code), show marker
            if(hash) {
                setTimeout(function(){ 
                    hashChange();
                }, 1500);
            }
           
        }  //end initmap




    </script>























<script type="module">

    import QrScanner from "./js/qr-scanner.min.js";
    QrScanner.WORKER_PATH = './js/qr-scanner-worker.min.js';
    QrScanner.NO_QR_CODE_FOUND = 'No QR';

    const video = document.getElementById('qr-video');
    const camHasCamera = document.getElementById('cam-has-camera');
    const camQrResult = document.getElementById('cam-qr-result');
    const fileSelector = document.getElementById('file-selector');
    const fileQrResult = document.getElementById('file-qr-result');
    const qr_cam = document.getElementById('qr-cam');
    const camera_toggle = document.getElementById('camera-toggle');

    function setResult(label, result) {
        label.style.color = 'teal';
        clearTimeout(label.highlightTimeout);
        label.highlightTimeout = setTimeout(() => label.style.color = 'inherit', 100);
        if(result.toString().includes("Test")) {
            result = result.toString().slice(5);
           // result = result.toString().split('#')[1]; // if QR code urls have hash
         
        //  console.log('same ' + window.location.href.split('#')[1]  + '+' + result);
            if(window.location.href.split('#')[1] != result) {  
                /*  Important to only auto-close camera popup if scanned hash is different: 
                    camera keeps the last seen frame before initialiing camera. 
                    As that was probably a QR code, it immediately reads the last frame and closes again... */

                scanner.stop();
                qr_cam.classList.remove("show");
                camera_toggle.classList.remove("show");
                window.location.hash = result;
        
                
            }  
            else{    
                result = 'already scanned';
            }
        }

        else{
            result = 'Wrong QR code';
        }
        label.textContent = result;

    }

    // ####### Web Cam Scanning #######

    QrScanner.hasCamera().then(hasCamera => camHasCamera.textContent = hasCamera);

    const scanner = new QrScanner(video, result => setResult(camQrResult, result), error => {
        camQrResult.textContent = error;
        camQrResult.style.color = 'inherit';
    });

   video.parentNode.insertBefore(scanner.$canvas, video.nextSibling);
   scanner.$canvas.setAttribute("id", "scan-area");

    document.getElementById('camera-toggle').addEventListener('click', () => {
      
        document.getElementById('settings-options').classList.remove("open");
        document.getElementById("welcome").classList.remove("open");
        if (qr_cam.classList.contains('show')) {
            qr_cam.classList.remove("show");
            camera_toggle.classList.remove("show");
            scanner.stop();
        } else {
            qr_cam.classList.add("show");
            camera_toggle.classList.add("show");
            scanner.start();
        }
        
       
    });
    
    // ####### File Scanning #######

    fileSelector.addEventListener('change', event => {
        const file = fileSelector.files[0];
        if (!file) {
            return;
        }
        QrScanner.scanImage(file)
            .then(result => setResult(fileQrResult, result))
            .catch(e => setResult(fileQrResult, e || ''));
    });

</script>
<!-- Async script executes immediately and must be after any DOM elements used in callback. -->
<script
src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB2EyNTL0A0-DhmL-KlRNdPzbm8ZJZSLxU&callback=initMap&map_ids=79077c97c96d524b&libraries=&v=weekly"
async
></script>
</body>
</html>
