<!DOCTYPE html>
<html lang="en">
    <head>   
     <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>

        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <meta charset="UTF-8">
        <title>QR Scanner Demo</title>

        <style>

            body{
                transition: all 0.5s;
            }
            #qr-video, #cam-has-camera, #flash-toggle {
                display: none;
            }
            hr {
                margin-top: 32px;
            }
            input[type="file"] {
                display: block;
                margin-bottom: 16px;
            }
            div {
                margin-bottom: 16px;
            }

            #camera-toggle {
                position: fixed;
                width: 25%;
                max-width: 4em;
                height: 25%;
                max-height: 4em;
                z-index: 100;
                left: 50%;
                bottom: 1em;
                transform: translate(-50%, 0);
                padding: 1em;
                border-radius: 50%;
                background:black url(img/search_w.png) no-repeat;
                background-size: 75%;
                background-position: 69% 77%;
                cursor: pointer;
                transition: 0.3s all;
            }
            #camera-toggle:hover {
                background:white url(img/search.png) no-repeat;
                background-size: 75%;
                background-position: 69% 77%;

            }
            #camera-toggle.show {
                transform: translate(-50%, 20%) scale(0.7);
                background:black url(img/close_w.png) no-repeat;
                background-size: 65%;
                background-position: 55% 55%;
            }
            
            #camera-toggle.show:hover {
                background:white url(img/close.png) no-repeat;
                background-size: 65%;
                background-position: 55% 55%;
            }

            #qr-cam {
                transition: all 0.5s ease-out;
                z-index: 10;
                width: 80%;
                margin: 0 auto;
                background: lightgray;
                border-radius: 2em;
                padding: 3%;
                max-width: 40em;
                position: fixed;
                left: 50%;
                bottom: 0;
                text-align: center;
                transform: translate(-50%, 100%);
                padding-bottom: 4em;
            }

            #qr-cam.show {

                transform: translate(-50%, 0%);
            }

            #qr-cam-holder{
                width: 100%;
                padding-top: 100%; /* 1:1 Aspect Ratio */
                position: relative; 

            }
            #scan-area {
                position: absolute;
                top: 0;
                left: 0;
                bottom: 0;
                right: 0;   
                width: 100%;
                height: 100%;
                background-color: ivory;
                border-radius: 10%;
                
            }


            #map {
                position: absolute;
                top: 0;
                left: 0;
                bottom: 0;
                right: 0;   
                width: 100%;
                height: 104%;
            }


        </style>

<script>
   // This example displays a marker at the center of Australia.
// When the user clicks the marker, an info window opens.

/*
function initMap() {
  const home = { lat: 52.1936373, lng: 0.1273479 };
  const map = new google.maps.Map(document.getElementById("map"), {
    zoom: 17,
    center: home,
    mapId: '79077c97c96d524b',
    mapTypeId: 'satellite',
   // disableDefaultUI: true,

  });


  
  const contentString =
    '<div id="content">' +
    '<div id="siteNotice">' +
    "</div>" +
    '<h1 id="firstHeading" class="firstHeading">Uluru</h1>' +
    '<div id="bodyContent">' +
    "<p><b>Uluru</b>, also referred to as <b>Ayers Rock</b>, is a large " +
    "sandstone rock formation in the southern part of the " +
    "Northern Territory, central Australia. It lies 335&#160;km (208&#160;mi) " +
    "south west of the nearest large town, Alice Springs; 450&#160;km " +
    "(280&#160;mi) by road. Kata Tjuta and Uluru are the two major " +
    "features of the Uluru - Kata Tjuta National Park. Uluru is " +
    "sacred to the Pitjantjatjara and Yankunytjatjara, the " +
    "Aboriginal people of the area. It has many springs, waterholes, " +
    "rock caves and ancient paintings. Uluru is listed as a World " +
    "Heritage Site.</p>" +
    '<p>Attribution: Uluru, <a href="https://en.wikipedia.org/w/index.php?title=Uluru&oldid=297882194">' +
    "https://en.wikipedia.org/w/index.php?title=Uluru</a> " +
    "(last visited June 22, 2009).</p>" +
    "</div>" +
    "</div>";
  const infowindow = new google.maps.InfoWindow({
    content: contentString,
  });
  const marker = new google.maps.Marker({
    position: home,
    map,
    title: "Uluru (Ayers Rock)",
  });

  marker.addListener("click", () => {
    infowindow.open(map, marker);
  });

  */
 

  let map, infoWindow;

 
var items=[];  var hintAreas=[];  var hintPopups=[];   var revealMarkers=[]; var revealPopups=[]; 

items.push(pink = {
    position: { lat: 52.194407, lng: 0.1256567 },
    name: 'pink',
    revealText: "<h1>Reveal 1</h1><p>info about this marker</p>",
    hintText: "<h1>Hint 1</h1><p>info about this marker</p>"
    });
items.push( blue = {
    position: { lat: 52.193142, lng: 0.1244538 },
    name: 'blue',
    revealText: "<h1>Reveal 2</h1><p>info about this marker</p>",
    hintText: "<h1>Hint 2</h1><p>info about this marker</p>"
    });
items.push( coral = {
    position: { lat: 52.194407, lng: 0.1296557 },
    name: 'coral',
    revealText: "<h1>Reveal 3</h1><p>info about this marker</p>",
    hintText: "<h1>Hint 3</h1><p>info about this marker</p>"
    });
items.push(green = {
    position: { lat: 52.193142, lng: 0.1281528 },
    name: 'green',  
    revealText: "<h1>Reveal 4</h1><p>info about this marker</p>",
    hintText: "<h1>Hint 4</h1><p>info about this marker</p>"
    });


const home = { lat: 52.193616, lng: 0.126948 };
homeInfo = "<h1>Introduction</h1><p>Welcome to the adventure!</p><p>Use the map to guide you to an area of interest, then when you find the QR code, open the camera below to scan the code and find out more!";
    

function initMap() {
    const map = new google.maps.Map(document.getElementById("map"), {
        zoom: 20,
        center: home,
        mapId: '79077c97c96d524b',
        mapTypeId: 'satellite',
        disableDefaultUI: true,  
        tilt:0
    });

  // intro popup + marker

    const introMarker = new google.maps.Marker({
        position: home,
        map,
        animation: google.maps.Animation.DROP,
        title: "'Tanics'",
        path: google.maps.SymbolPath.CIRCLE,
      
    });
    introWindow = new google.maps.InfoWindow({
        position: home,
        content: homeInfo,
        pixelOffset:300,
        maxWidth: 300,

    });
   // introWindow.setPosition(home);
    //introWindow.setContent(homeInfo);
    //introWindow.pixelOffset = 100;
    introWindow.open(map);

    introMarker.addListener("click", () => {
        map.setZoom(20);
        map.panTo(introMarker.position);
       // revealPopup.open(null);
        introWindow.open(map)
    });

    map.addListener("center_changed", () => {
        introWindow.open(null);   // hide popup
      
    });


  function createHint(name, hintArea, hintPopup, position, title, hintText) {
    
    hintArea =  new google.maps.Circle({
      strokeColor: "#FF0000",
      strokeOpacity: 0.8,
      strokeWeight: 2,
      fillColor: "#FF0000",
      fillOpacity: 0.35,
      map,
      center: position,
      radius: 10,
      title:name,
    });

    hintAreas.push(hintArea);
    hintPopup = new google.maps.InfoWindow({
        position:position,
        content:hintText,
        maxWidth: 200,
    });
    hintPopups.push(hintPopup);


   // console.log(Object.getOwnPropertyNames(revealMarker));
    hintArea.addListener("click", () => {
        map.setZoom(20);
        map.panTo(position);
        hintPopup.open(map);
       // revealPopup.open(null);
        introWindow.open(null)
    });

    map.addListener("center_changed", () => {
        hintPopup.close();   // hide popup
      /*  window.setTimeout(() => {
             map.panTo(circleName.getPosition());
        }, 1000);
        */
    });

}



function createReveal (name, revealMarker, revealPopup, position, revealText) {

    revealMarker = new google.maps.Marker({
        position: position,
        map,
        animation: google.maps.Animation.DROP,
        title: name,
        
    });
    revealMarkers.push(revealMarker);

    revealPopup = new google.maps.InfoWindow({
        position:position,
        content:revealText,
        maxWidth: 200,
    });
    revealPopups.push(revealPopup);

    revealMarker.addListener("click", () => {
        map.setZoom(20);
        map.panTo(position);        
        revealPopup.open(map);
    });

    map.addListener("click", () => {
        revealPopup.close();   // hide popup
      
    });
    revealPopup.open(map);
    
}


for(i=0;i<items.length;i++) {  
    createHint(items[i].name, items[i].name + 'HintArea', items[i].name + 'HintPopup', items[i].position, items[i].name, items[i].hintText);
}


google.maps.event.addDomListener(window, "hashchange", () => {
    var hash = window.location.href.split('#')[1];
    
    const reveal = items.find(x => x.name === hash);
    const index = items.indexOf(reveal);

    hintAreas[index].setMap(null); //hide hint for this scan

    revealPopups.forEach(revealPopup => revealPopup.close()); // close all reveal popups
    createReveal(reveal.name, reveal.name + 'Marker', reveal.name + 'Popup', reveal.position, reveal.revealText);
    
    map.panTo(items[index].position);
   
  });

    /* // G E O L O C A T I O N
  if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        (position) => {
          const pos = {
            lat: position.coords.latitude,
            lng: position.coords.longitude,
          };
        //  geoWindow.setPosition(pos);
        //  geoWindow.setContent("You are Here");
        //  geooWindow.open(map);
        //  map.setCenter(pos); 
        },
        () => {
          handleLocationError(true, infoWindow, map.getCenter());
        }
      );
    } else {
      // Browser doesn't support Geolocation
      handleLocationError(false, infoWindow, map.getCenter());
    }
*/
  /*

  infoWindow = new google.maps.InfoWindow();
  const locationButton = document.createElement("button");
  locationButton.textContent = "Pan to Current Location";
  locationButton.classList.add("custom-map-control-button");
  map.controls[google.maps.ControlPosition.TOP_CENTER].push(locationButton);
  locationButton.addEventListener("click", () => {
    // Try HTML5 geolocation.
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        (position) => {
          const pos = {
            lat: position.coords.latitude,
            lng: position.coords.longitude,
          };
          infoWindow.setPosition(pos);
          infoWindow.setContent("Location found.");
          infoWindow.open(map);
          map.setCenter(pos);
        },
        () => {
          handleLocationError(true, infoWindow, map.getCenter());
        }
      );
    } else {
      // Browser doesn't support Geolocation
      handleLocationError(false, infoWindow, map.getCenter());
    }

    
  });*/
}

function handleLocationError(browserHasGeolocation, infoWindow, pos) {
 // infoWindow.setPosition(pos);
  console.log(
    browserHasGeolocation
      ? "Error: The Geolocation service failed."
      : "Error: Your browser doesn't support geolocation."
  );
//  infoWindow.open(map);
}


  </script>

    </head>
<body>
    <div id="camera-toggle"></div>
    <div id="qr-cam" >
        <div id="qr-cam-holder">
            <span id="cam-has-camera"></span>
            <video id="qr-video"></video>
            <br>
        </div>

        <span id="cam-qr-result">Scanning</span>
        
        <div id="qr-select-holder">
            <input type="file" id="file-selector">
            <span id="file-qr-result"></span>
        </div>
    </div>
    
    <div id="map"></div>
    

<script type="module">

    import QrScanner from "./js/qr-scanner.min.js";
    QrScanner.WORKER_PATH = './js/qr-scanner-worker.min.js';
    QrScanner.NO_QR_CODE_FOUND = 'No QR';

    const video = document.getElementById('qr-video');
    const camHasCamera = document.getElementById('cam-has-camera');
    const camQrResult = document.getElementById('cam-qr-result');
    const fileSelector = document.getElementById('file-selector');
    const fileQrResult = document.getElementById('file-qr-result');

    function setResult(label, result) {
        label.style.color = 'teal';
        clearTimeout(label.highlightTimeout);
        label.highlightTimeout = setTimeout(() => label.style.color = 'inherit', 100);
        if(result.toString().includes("Test")) {
            result = result.toString().slice(5);
           // document.body.style.backgroundColor = result;
         //   console.log('same ' + window.location.href.split('#')[1]  + '+' + result);
            if(window.location.href.split('#')[1] != result) {
                console.log(' not same' + window.location.href.split('#')[1]  + '+' + result);

                scanner.stop();
                qr_cam.classList.remove("show");
                camera_toggle.classList.remove("show");
                window.location.hash = result;
        
                //not same
               
            }  
            else{    
                result = 'already scanned';
            }
        }

        else{
            result = 'Wrong QR code';
        }
        label.textContent = result;

    }

    // ####### Web Cam Scanning #######

    QrScanner.hasCamera().then(hasCamera => camHasCamera.textContent = hasCamera);

    const scanner = new QrScanner(video, result => setResult(camQrResult, result), error => {
        camQrResult.textContent = error;
        camQrResult.style.color = 'inherit';
    });

   video.parentNode.insertBefore(scanner.$canvas, video.nextSibling);
   scanner.$canvas.setAttribute("id", "scan-area");
   var qr_cam = document.getElementById('qr-cam');
    var camera_toggle = document.getElementById('camera-toggle');

    document.getElementById('camera-toggle').addEventListener('click', () => {
      
        if (qr_cam.classList.contains('show')) {
            qr_cam.classList.remove("show");
            camera_toggle.classList.remove("show");
            scanner.stop();
        } else {
            qr_cam.classList.add("show");
            camera_toggle.classList.add("show");
            scanner.start();
        }
        
       
    });
    
    // ####### File Scanning #######

    fileSelector.addEventListener('change', event => {
        const file = fileSelector.files[0];
        if (!file) {
            return;
        }
        QrScanner.scanImage(file)
            .then(result => setResult(fileQrResult, result))
            .catch(e => setResult(fileQrResult, e || ''));
    });

</script>
<!-- Async script executes immediately and must be after any DOM elements used in callback. -->
<script
src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB2EyNTL0A0-DhmL-KlRNdPzbm8ZJZSLxU&callback=initMap&map_ids=79077c97c96d524b&libraries=&v=weekly"
async
></script>
</body>
</html>
